<template>
  <div>
    <div v-if="isMenuOpen">
      <div class="font-size-14 font-weight-500 pt-2">
        Duplicate Course
      </div>
      <div class="my-2">
        <select
          id="add-course-select"
          v-model="selected"
          class="select-menu"
          :disabled="isSaving || !options.length"
        >
          <option
            id="add-course-select-option-null"
            :value="null"
            @click="onSelect"
          >
            Choose...
          </option>
          <option
            v-for="option in options"
            :id="`add-course-select-option-${option.id}`"
            :key="option.id"
            :value="option"
            @click="onSelect"
          >
            {{ option.name }}
          </option>
        </select>
      </div>
      <div class="d-flex mt-3">
        <div>
          <ProgressButton
            id="add-course-save-btn"
            :action="onClickSave"
            color="primary"
            :disabled="isSaving || !selected"
            :in-progress="isSaving"
            size="small"
            :text="isSaving ? 'Saving' : 'Save'"
          />
        </div>
        <div>
          <v-btn
            id="add-course-cancel-btn"
            :disabled="isSaving"
            variant="text"
            @click="cancel"
          >
            Cancel
          </v-btn>
        </div>
      </div>
    </div>
    <div v-if="!isMenuOpen">
      <span v-if="!options.length" aria-live="polite" class="sr-only">No courses available to copy.</span>
      <v-btn
        v-if="currentUser.canEditDegreeProgress"
        id="duplicate-existing-course"
        class="align-center d-flex flex-row-reverse p-0"
        :disabled="degreeStore.disableButtons || !options.length"
        variant="text"
        @click.prevent="openMenu"
      >
        <div class="font-size-16 text-no-wrap">
          Duplicate Course
        </div>
        <div class="font-size-14 pr-1">
          <v-icon :icon="mdiPlus" />
        </div>
      </v-btn>
    </div>
  </div>
</template>

<script setup>
import {alertScreenReader, putFocusNextTick} from '@/lib/utils'
import {copyCourse} from '@/api/degree'
import {mdiPlus} from '@mdi/js'
import {refreshDegreeTemplate} from '@/stores/degree-edit-session/utils'
import {computed, ref} from 'vue'
import {filter as _filter, sortBy} from 'lodash'
import {useContextStore} from '@/stores/context'
import {useDegreeStore} from '@/stores/degree-edit-session/index'
import ProgressButton from '@/components/util/ProgressButton.vue'

const contextStore = useContextStore()
const degreeStore = useDegreeStore()

const currentUser = contextStore.currentUser
const isMenuOpen = ref(false)
const isSaving = ref(false)
const selected = ref(null)
const options = computed(() => {
  const courses = degreeStore.courses.value.assigned.concat(degreeStore.courses.value.unassigned)
  return _filter(sortBy(courses, [c => c.name.toLowerCase()], ['name', 'id']), c => !c.isCopy)
})

const cancel = () => {
  isMenuOpen.value = this.isSaving = false
  degreeStore.setDisableButtons(false)
  alertScreenReader('Canceled')
  putFocusNextTick('duplicate-existing-course')
}

const onClickSave = () => {
  isSaving.value = true
  alertScreenReader('Saving')
  copyCourse(selected.value.id).then(course => {
    refreshDegreeTemplate(degreeStore.templateId.value).then(() => {
      isMenuOpen.value = isSaving.value = false
      selected.value = null
      degreeStore.setDisableButtons(false)
      alertScreenReader('Course duplicated and put in the list of Unassigned.')
      putFocusNextTick(`assign-course-${course.id}-menu-container`, 'button')
    })
  })
}

const onSelect = () => {
  alertScreenReader(selected.value ? `${selected.value.name} selected` : 'Selection set to null.')
}

const openMenu = () => {
  degreeStore.setDisableButtons(true)
  isMenuOpen.value = true
  alertScreenReader('The \'Duplicate Course\' menu is open.')
  putFocusNextTick('add-course-select')
}
</script>
